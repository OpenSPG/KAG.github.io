# 领域知识挂载

# 介绍
在某些垂直领域如医疗、法律、金融等，可能累积了较多的结构化专家知识图谱。这些领域知识图谱可以作为非结构化知识图谱抽取的先验，一方面辅助知识抽取、另一方面也可以有效提升整个图谱的质量，进而提升推理问答的准确率。

为了支持领域知识图谱的挂载，KAG 在V0.6增加了`ExternalGraphLoader`组件，提供以下基础的功能支持：

1. 加载并导入现有领域知识图谱到图数据库
2. 在知识抽取组件（Extractor）中，基于领域知识图谱节点对文档进行实体识别
3. 在PostProcessor组件中，将从非结构化文档抽取出的实体链指（标准化）到领域知识图谱的节点上



通过以上方式，用户从非结构化文档中构建出的图谱可以与已有领域知识图谱进行融合，从而获得更高质量的索引。

# 使用示例
domain_kg中提供了一个医疗领域知识挂载的案例，其中领域知识图谱的节点为医学名词，关系为isA。文档内容为部分医学名词的介绍。可参考readme文档进行初步体验。

**代码路径:**`**kag/examples/domain_kg/**`



# 领域知识挂载组件实现
KAG领域知识挂载组件的基类为`kag.interface.builder.external_graph_abc.ExternalGraphLoaderABC`，用户可以使用以下命令查看默认实现相关信息：

```bash
$ kag interface --cls ExternalGraphLoaderABC
```

会打印如下信息：

```plain
                    Documentation of ExternalGraphLoaderABC
Abstract base class for loading and interacting with external knowledge graphs.

This class defines the interface for components that load and interact with external knowledge graphs.
It inherits from `BuilderComponent` and provides methods for dumping subgraphs, performing named entity
recognition (NER), retrieving allowed labels, and matching entities.
                    Registered subclasses of ExternalGraphLoaderABC
[kag.builder.component.external_graph.external_graph.DefaultExternalGraphLoader]
Register Name: "base"

Documentation:
A default implementation of the ExternalGraphLoaderABC interface.

This class is responsible for loading external graph data based on the provided nodes, edges, and match configuration.

Initializer:
Creates an instance of DefaultExternalGraphLoader from JSON files containing node and edge data.

Args:
    node_file_path (str): The path to the JSON file containing node data.
    edge_file_path (str): The path to the JSON file containing edge data.
    match_config (MatchConfig): The configuration for matching query str to graph nodes.

Returns:
    DefaultExternalGraphLoader: An instance of DefaultExternalGraphLoader initialized with the data from the JSON files.

Required Arguments:
  node_file_path: str
  edge_file_path: str
  match_config: MatchConfig

Optional Arguments:
  No Optional Arguments found

Sample Useage:
  ExternalGraphLoaderABC.from_config({'type': 'base', 'node_file_path': 'Your node_file_path config', 'edge_file_path': 'Your edge_file_path config', 'match_config': 'Your match_config config'})

```

可见KAG框架目前提供了一个注册名为`"base"`的默认实现，其类路径为`kag.builder.component.external_graph.external_graph.DefaultExternalGraphLoader`

下面对关键接口进行详细说明：

## 组件初始化
`DefaultExternalGraphLoader`的初始化接口包含如下入参：

+ node_file_path (str)

领域知识图谱的节点数据，为json格式，形如：

```json
[
    {
        "id": "00000001,
        "name": "(缩)肾上腺皮质激素",
        "label": "Concept",
        "properties": {

        }
    },
    {
        "id": "00000002",
        "name": "促肾上腺皮质激素",
        "label": "Concept",
        "properties": {

        }
    }
]
```

该格式即为KAG框架中默认的图节点数据模型(`kag.builder.model.sub_graph.Node`)，各字段介绍如下：

    - `id`：节点唯一ID
    - `name`：节点名称
    - `label`：节点类型，须存在于schema定义中
    - `properties`：可选字段，用于储存节点的额外属性
+ edge_file_path (str)

领域知识图谱的关系数据，为json格式，形如：

```json
[
    {
        "id": "00000001-00000002",
        "from": "00000001",
        "fromType": "Concept",
        "to": "00000002",
        "toType": "Concept",
        "label": "isA",
        "properties": {

        }
    },
    {
        "id": "00000001-00000003",
        "from": "00000001",
        "fromType": "Concept",
        "to": "00000003",
        "toType": "Concept",
        "label": "isA",
        "properties": {

        }
    }
]
```

该格式即为KAG框架中默认的图关系数据模型(`kag.builder.model.sub_graph.Edge`)，，各字段介绍如下：

    - `id`

关系的唯一ID

    - `label`

关系的类型

    - `from`

关系起点ID

    - `fromType`

关系起点类型

    - `to`

关系终点ID

    - `toType`

关系终点类型

    - `properteis`

可选字段，用于储存节点的额外属性



+ match_config (MatchConfig)

`kag.interface.MatchConfig`类型对象，定义了外部实体链指到本领域知识图谱上的实体节点时的配置，其实现如下：

```python
class MatchConfig(Registrable):
    """
    Configuration class for matching operations.

    This class is used to define the parameters for matching operations, such as the number of matches to return,
    the labels to consider, and the threshold for matching confidence.

    Attributes:
        k (int): The number of matches to return. Defaults to 1.
        labels (List[str]): The list of labels to consider for matching. Defaults to None.
        threshold (float): The confidence threshold for matching. Defaults to 0.9.
    """

    def __init__(self, k: int = 1, labels: List[str] = None, threshold: float = 0.9):
        """
        Initializes the MatchConfig with the specified parameters.

        Args:
            k (int, optional): The number of matches to return. Defaults to 1.
            labels (List[str], optional): The list of labels to consider for matching. Defaults to None.
            threshold (float, optional): The confidence threshold for matching. Defaults to 0.9.
        """
        self.k = k
        self.labels = labels
        self.threshold = threshold

```

## 基于领域知识图谱执行实体识别
`DefaultExternalGraphLoader`提供了`ner`接口，可以基于领域知识图谱中包含的实体，对文本进行实体识别。相比基于LLM的实体识别，可以更好的融入特定领域的知识。接口定义如下：

```python
    def ner(self, content: str):
        output = []
        import jieba

        for word in jieba.cut(content):
            if word in self.vocabulary:
                output.append(self.vocabulary[word])
        return output

```

当前的实现基于中文分词和字符串匹配，用户可自行扩展更多策略。



## 基于领域知识图谱执行实体链指
在很多场景中，我们期望将抽取出的实体链指到标准的领域知识实体节点，即对实体做标准化。对于开放领域，借助LLM可以很好的完成此任务。但是对于特定垂直领域，LLM往往缺乏相关知识或概念。`DefaultExternalGraphLoader`提供了`match_entity`接口，通过文本匹配或向量匹配的方式，寻找任意实体与领域知识图谱中最相似的节点。接口定义如下：

```python
    def match_entity(self, query: Union[str, List[float], np.ndarray]):
        if isinstance(query, str):
            return self.text_match(
                query, k=self.match_config.k, labels=self.match_config.labels
            )
        else:
            return self.vector_match(
                query,
                k=self.match_config.k,
                labels=self.match_config.labels,
                threshold=self.match_config.threshold,
            )

```

其中,`match_config`定义了链指的策略，如链指实体的数量，相似度阈值等。

# 自定义扩展


前述领域知识挂载组件只包含了基础的功能， 难以覆盖各个业务。用户如果有额外的需求，可以参考[自定义代码](https://openspg.yuque.com/ndx6g9/docs/mxdhqfad16p4f8pk)章节，对组件进行扩展。主要包含如下扩展点：

1. 扩展ExternalGraphLoader组件

例如支持加载不同格式的领域知识文件、自定义`ner`和`match_entity`策略

2. 扩展Extractor组件

例如在抽取过程中自定义领域知识如何干预或修正抽取结果

3. 扩展Solver组件

例如在推理问答过程中优先基于领域知识进行检索召回





****



